//@version=5
strategy(shorttitle="BB Strategy", title="Bollinger Bands Strategy", overlay=true, 
         commission_type=strategy.commission.percent, commission_value=0.1, 
         slippage=3, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// Date range inputs
startDate = input.time(timestamp("2018-01-01 00:00"), "Start Date")
endDate = input.time(timestamp("2069-12-31 23:59"), "End Date")

// Original indicator inputs
length = input.int(20, minval=1)
maType = input.string("SMA", "Basis MA Type", options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
src = input(close, title="Source")
mult = input.float(2.0, minval=0.001, maxval=50, title="StdDev")

// MA function
ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

// Calculate Bollinger Bands
basis = ma(src, length, maType)
dev = mult * ta.stdev(src, length)
upper = basis + dev
lower = basis - dev

// Plotting
offset = input.int(0, "Offset", minval = -500, maxval = 500, display = display.data_window)
plot(basis, "Basis", color=#2962FF, offset = offset)
p1 = plot(upper, "Upper", color=#F23645, offset = offset)
p2 = plot(lower, "Lower", color=#089981, offset = offset)
fill(p1, p2, title = "Background", color=color.rgb(33, 150, 243, 95))

// Date filter
inDateRange = time >= startDate and time <= endDate

// Strategy logic
longCondition = ta.crossover(close, upper) and inDateRange
exitCondition = ta.crossunder(close, lower)

// Execute trades
if longCondition
    strategy.entry("Long", strategy.long)

if exitCondition and strategy.position_size > 0
    strategy.close("Long")

// Close all positions if out of date range
if not inDateRange and strategy.position_size > 0
    strategy.close_all()